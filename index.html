<!DOCTYPE html>
<html>
<head>
    <title>Pokémon Map</title>
    <meta name="description" content="Pokémon Map">
    <meta name="author" content="Ellen Langelaar">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <link rel='shortcut icon' type='image/x-icon' href='/favicon.ico' />
    <meta charset="utf-8">
    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="map"></div>

<div id="pokemon-logo">
    <img src="img/pokemon-logo.png" onerror="this.style='display:none'">
</div>

<div id="menu-open"><i class="fa fa-bars" aria-hidden="true"></i></div>

<div id="menu">
    <div id="menu-close"><i class="fa fa-chevron-right" aria-hidden="true"></i></div>
    <div id="main-wrapper">
        <table class="table">
            <tr>
                <td>
                    <h3>Show only</h3>
                    <select id="filter-pokemon" title="pokemon" class="form-control">
                        <option value="all" selected>Everything</option>
                        <option value="pokestop">Pokestops</option>
                        <option value="gym">Gyms</option>
                        <option disabled>-------</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td><button class="btn btn-primary btn-add-pokemon">Add a location</button></td>
            </tr>
        </table>

    </div>
    <div id="add-wrapper">
        <h4>Add a location</h4>
        <hr class="no-margin-top">
        <table class="table table-bordered">
            <tr>
                <td>
                    <select id="add-pokemon" title="pokemon" class="form-control">
                        <option disabled selected>Pokémon</option>
                        <option value="pokestop">Pokestop</option>
                        <option value="gym">Gym</option>
                        <option disabled>-------</option>
                    </select>
                </td>
            </tr>
            <tr>
                <td>
                    <input disabled id="add-latitude" type="text" class="form-control" placeholder="Latitude" maxlength="200">
                </td>
            </tr>
            <tr>
                <td>
                    <input disabled id="add-longitude" type="text" class="form-control" placeholder="Longitude" maxlength="200">
                </td>
            </tr>
            <tr>
                <td>
                    <input id="add-name" type="text" class="form-control" placeholder="Your name" maxlength="100">
                </td>
            </tr>
            <tr>
                <td>
                    <button id="add" class="form-control btn btn-primary">Add</button>
                </td>
            </tr>
            <tr>
                <td>
                    <button class="form-control btn btn-default btn-return-main">Back</button>
                </td>
            </tr>
        </table>
    </div>

    <div id="add-success">
        <h2>Added successful!</h2>
        <div class="col-md-12">
            <button class="btn btn-primary btn-add-pokemon"><i class="fa fa-plus" aria-hidden="true"></i> Add another</button>
        </div>
        <div class="col-md-12">
            <br>
            <button class="btn btn-danger" id="btn-undo-add"><i class="fa fa-repeat" aria-hidden="true"></i> Undo</button>
        </div>
        <div class="col-md-12">
            <br>
            <button class="form-control btn btn-default btn-return-main">Back</button>
        </div>

        <input id="setSighting-id" type="hidden" value="0">
    </div>

    <div id="add-error">
        <h2>Oops!</h2>
        <h3>There was an error.</h3>
        <button class="btn btn-primary" onclick="location.reload()"><i class="fa fa-repeat" aria-hidden="true"></i> Reload</button>
    </div>

    <div id="trademark">
        <a href="http://www.ellenlangelaar.nl"><img src="http://ellenlangelaar.nl/img/ellenlangelaar.png" alt="ellenlangelaar.nl"></a>
    </div>
</div>

<div id="legenda">
    <table class="table table-bordered table-condensed">
        <tr>
            <td><i class="fa fa-circle yellow" aria-hidden="true"></i></td>
            <td>Gym</td>
        </tr>
        <tr>
            <td><i class="fa fa-circle blue" aria-hidden="true"></i></td>
            <td>Pokéstop</td>
        </tr>
        <tr>
            <td><i class="fa fa-circle red" aria-hidden="true"></i></td>
            <td>Pokémon</td>
        </tr>
    </table>
</div>



<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script src="config.js"></script>
<script>
    $(document).ready(function() {
        // CLICK EVENT TO OPEN THE MOBILE MENU
        $('#menu-open').click(function(e){
            $('#menu').css('display','block');
            $('#menu-open').css('display','none');
        });

        // CLICK EVENT TO CLOSE THE MOBILE MENU
        $('#menu-close').click(function(e){
            $('#menu').css('display','none');
            $('#menu-open').css('display','block');
        });

        // CLICK EVENT FOR RETURN TO MAIN
        $('.btn-return-main').click(function(){
            $('#add-wrapper').hide();
            $('#add-error').hide();
            $('#add-success').hide();
            $('#main-wrapper').show();
        });

        // CLICK EVENT FOR ADDING A POKEMON
        $('#add').click(function(e){
            sendSighting();
        });

        // CLICK EVENT FOR SHOWING THE ADD PAGE
        $('#btn-add-pokemon').click(function(){
            location.reload(); // TODO: Fix in future, show name etc.
        });

        // CLICK EVENT FOR SHOWING THE ADD PAGE
        $('.btn-add-pokemon').click(function(){
            $('#main-wrapper').hide();
            $('#add-error').hide();
            $('#add-success').hide();
            $('#add-wrapper').show();
        });

        // CLICK EVENT FOR UNDOING THE ADD
        $('#btn-undo-add').click(function(){
            var id = $('#setSighting-id').val();
            if(id > 0){
                $.ajax({
                    url: $GLOBALS.URLPHP+"unsetSighting.php",
                    type: "POST",
                    data: {id : id}
                }).done(function(data) {
                    var obj = JSON.parse(data);
                    if(obj > 0){
                        location.reload(); // TODO: Handle this a bit better, reload data instead of page
                    } else {
                        console.log('error!', obj);
                        // SHOW ERROR
                        $('#add-wrapper').hide();
                        $('#add-error').show();
                    }
                });
            }
        });

        $('#filter-pokemon').on('change', function(e){
            var choice = $(this).val();
            initMap();
            if(choice > 0){
                getDataPoints('pokemon&id='+choice);
            } else {
                getDataPoints(choice);
            }
        });

        // SET SELECT VALUES
        setPokemon();

        // SHOW ALL DATA POINTS
        getDataPoints('all');
    });


    /**
     * Init the map
     */
    var map;
    var marker;
    var locations = [];
    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: {lat: 52.211840, lng: 5.971564},
            zoom: 14,
            disableDefaultUI: true,
            zoomControl: true
        });

        google.maps.event.addListener(map, 'click', function(args) {
            $('#add-latitude').val(args.latLng.lat());
            $('#add-longitude').val(args.latLng.lng());
            placeMarker({lat: args.latLng.lat(), lng: args.latLng.lng()}, null, null, true);
        });

        marker = null;
    }

    /**
     * Place a marker on the screen to show where you clicked
     */
    function placeMarker(location, type, pokemon, newLocationMarker) {
        if(newLocationMarker){
            if ( marker) {
                marker.setPosition(location);
            } else {
                marker = new google.maps.Marker({
                    position: location,
                    map: map,
                    icon: 'img/markers/main.png'
                });
            }
        } else {
            var icon = type === 1 ? '/img/pokemon/'+pokemon.replace('#', '')+'.png' : type === 2 ? '/img/markers/pokestop.png' : '/img/markers/gym.png';
            if(type === 1){
                icon = new google.maps.MarkerImage(icon,
                        new google.maps.Size(50, 50),
                        new google.maps.Point(0, 0),
                        new google.maps.Point(20, 20));
            }

            var temp = new google.maps.Marker({
                position: location,
                map: map,
                icon: icon
            });
            locations.push(temp);
        }

    }

    /**
     * Place all the data points on the map
     */
    function placeDataPoints(data){
        for(i = 0; i < data.length; i++) {
            // SET VARIABLES
            var type = data[i][2];
            var radius = type === 1 ? 0.02 : type === 2 ? 0.01 : 0.01;

            // CREATE A NEW CIRCLE ON THE MAP
            var circle = new google.maps.Polygon({
                map: map,
                paths: [drawCircle(new google.maps.LatLng(data[i][0],data[i][1]), radius, 1)],
                strokeColor: type === 1 ? "FF0000" : type === 2 ? "#162C57" : "#B3AD28",
                strokeOpacity: 1,
                strokeWeight: type === 1 ? 0 : 2,
                fillColor: type === 1 ? '#FF0000' : type === 3 ? '#EEE60F' : '#283BEE',
                fillOpacity: type === 1 ? 0.35 : 0.7
            });

            placeMarker({lat: data[i][0], lng: data[i][1]}, type, data[i][3]);

            // ADD A CLICK EVENT SO OTHER POKEMONS CAN BE ADDED ON TOP OF IT
            google.maps.event.addListener(circle, 'click', function(args) {
                $('#add-latitude').val(args.latLng.lat());
                $('#add-longitude').val(args.latLng.lng());
                placeMarker({lat: args.latLng.lat(), lng: args.latLng.lng()}, null, null, true);
            });
        }
    }

    /**
     * Get all the data points
     */
    function getDataPoints(type) {
        var dataPoints = [];
        $.ajax({
            url: $GLOBALS.URLPHP+"getSighting.php?type="+type,
            context: document.body
        }).done(function(data) {
            var obj = JSON.parse(data);
            $.each(obj, function(k, v) {
                var s = [parseFloat(v[0]),parseFloat(v[1]), parseInt(v[2]), v[3]];
                dataPoints.push(s);
            });
            placeDataPoints(dataPoints);
        });
    }

    /**
     * Draw the actual circle area
     */
    function drawCircle(point, radius, dir) {
        var d2r = Math.PI / 180;   // degrees to radians
        var r2d = 180 / Math.PI;   // radians to degrees
        var earthsradius = 3963; // 3963 is the radius of the earth in miles

        var points = 32;

        // find the raidus in lat/lon
        var rlat = (radius / earthsradius) * r2d;
        var rlng = rlat / Math.cos(point.lat() * d2r);

        var extp = [];
        if (dir==1) {
            var start=0;
            var end=points+1; // one extra here makes sure we connect the path
        } else {
            var start=points+1;
            var end=0;
        }
        for (var i=start; (dir==1 ? i < end : i > end); i=i+dir)
        {
            var theta = Math.PI * (i / (points/2));
            ey = point.lng() + (rlng * Math.cos(theta)); // center a + radius x * cos(theta)
            ex = point.lat() + (rlat * Math.sin(theta)); // center b + radius y * sin(theta)
            extp.push(new google.maps.LatLng(ex, ey));
        }
        return extp;
    }

    /**
     * Set the pokemon select box options
    * */
    function setPokemon() {
        $.ajax({
            url: $GLOBALS.URLPHP+"getSelectValues.php?type=pokemon",
            context: document.body
        }).done(function(data) {
            var obj = JSON.parse(data);
            $.each(obj, function(k, v) {
                $('#add-pokemon').append($("<option></option>").attr("value",v[0]).text(v[1]));
                $('#filter-pokemon').append($("<option></option>").attr("value",v[0]).text(v[1]));
            });
        });
    }

    /**
     * Save a sighting to the database
     */
    function sendSighting(){
        var pokemon = $('#add-pokemon').val();
        var type = 1;
        var latitude = $('#add-latitude').val();
        var longitude = $('#add-longitude').val();
        var name = $('#add-name').val();

        if(pokemon === 'pokestop'){
            type = 2;
            pokemon = 0;
        } else if(pokemon === 'gym'){
            type = 3;
            pokemon = 0;
        }

        // VALIDATE THE INPUTS
        var valid = true;
        if(pokemon === null){
            $('#add-pokemon').parent().addClass('has-error');
            valid = false;
        } else {
            $('#add-pokemon').parent().removeClass('has-error');
        }
        if(latitude.replace(/\s/g, "").length <= 0){
            $('#add-latitude').parent().addClass('has-error');
            valid = false;
        } else {
            $('#add-latitude').parent().removeClass('has-error');
        }
        if(longitude.replace(/\s/g, "").length <= 0){
            $('#add-longitude').parent().addClass('has-error');
            valid = false;
        } else {
            $('#add-longitude').parent().removeClass('has-error');
        }
        if(name.replace(/\s/g, "").length <= 0){
            name = 'Anonymous';
        }

        // SEND VALID DATA TO DB
        if(valid){
            $.ajax({
                method: 'POST',
                url: $GLOBALS.URLPHP+"setSighting.php",
                data: {
                    pokemon: pokemon,
                    type: type,
                    latitude: latitude,
                    longitude: longitude,
                    name: name
                }
            }).done(function(data) {
                var obj = JSON.parse(data);
                if(obj > 0){
                    $('#setSighting-id').val(obj);

                    // SHOW SUCCESS
                    $('#add-wrapper').hide();
                    $('#add-success').show();

                    // CLEAR OUT THE INPUTS
                    $('#add-pokemon').val(null);
                    $('#add-type').val(null);
                    $('#add-latitude').val('');
                    $('#add-longitude').val('');

                    // EXCEPT FOR NAME IF IT'S NOT ANONYMOUS
                    $('#add-name').val() === 'Anonymous' ? $('#add-name').val('') : null; // for future use?

                    initMap();
                    getDataPoints('all');
                    //location.reload(); // TODO: Handle this a bit better, reload data instead of page
                } else {
                    console.log('error!', obj);
                    // SHOW ERROR
                    $('#add-wrapper').hide();
                    $('#add-error').show();
                }
            });
        }
    }
</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBiFEtjVXiqBMGa_ZNtqUywQF8c2ySCHUQ&callback=initMap"></script>
<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-37182945-2', 'auto');
    ga('send', 'pageview');

</script>
</body>
</html>